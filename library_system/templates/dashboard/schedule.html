<!-- templates/dashboard/schedule.html -->
{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Schedule{% endblock %}

{% block navbar_icon %}{% if user.is_teacher %}fa-chalkboard-teacher{% else %}fa-graduation-cap{% endif %}{% endblock %}
{% block navbar_title %}{% if user.is_teacher %}Teacher{% else %}Student{% endif %} Dashboard{% endblock %}
{% block navbar_home_url %}{% if user.is_teacher %}{% url 'dashboard:teacher_dashboard' %}{% else %}{% url 'dashboard:student_dashboard' %}{% endif %}{% endblock %}

{% block sidebar_content %}
<h3>Navigation</h3>
<ul>
    <li><a href="{% if user.is_teacher %}{% url 'dashboard:teacher_dashboard' %}{% else %}{% url 'dashboard:student_dashboard' %}{% endif %}"><i class="fas fa-home"></i> Home</a></li>
</ul>

{% if user.is_teacher %}
<h3>School</h3>
<ul>
    <li><a href="{% url 'dashboard:schedule' %}" class="active"><i class="fas fa-calendar"></i> Schedule</a></li>
    <li><a href="#"><i class="fas fa-users"></i> Students</a></li>
</ul>

<h3>Management</h3>
<ul>
    <li><a href="#"><i class="fas fa-user"></i> Profile</a></li>
    <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
    <li><a href="#"><i class="fas fa-check-circle"></i> Live Attendance</a></li>
    <li><a href="#"><i class="fas fa-edit"></i> Manual Entry</a></li>
    <li><a href="#"><i class="fas fa-search"></i> Search / Filter</a></li>
</ul>

<h3>Reports</h3>
<ul>
    <li><a href="#"><i class="fas fa-chart-line"></i> Analytics</a></li>
    <li><a href="#"><i class="fas fa-eye"></i> Overview</a></li>
    <li><a href="#"><i class="fas fa-file-alt"></i> Reports</a></li>
    <li><a href="#"><i class="fas fa-list"></i> Scan Logs</a></li>
</ul>
{% else %}
<h3>School</h3>
<ul>
    <li><a href="#"><i class="fas fa-user"></i> Profile</a></li>
    <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
    <li><a href="{% url 'dashboard:schedule' %}" class="optional active"><i class="fas fa-calendar"></i> Class Schedule</a></li>
    <li><a href="#"><i class="fas fa-chart-bar"></i> Summary</a></li>
    <li><a href="#"><i class="fas fa-clock"></i> Today's Status</a></li>
    <li><a href="#"><i class="fas fa-list"></i> Attendance Log</a></li>
    <li><a href="#"><i class="fas fa-qrcode"></i> My QR Code</a></li>
</ul>

<h3>Events</h3>
<ul>
    <li><a href="#"><i class="fas fa-chart-pie"></i> Event Summary</a></li>
    <li><a href="#"><i class="fas fa-history"></i> Event History</a></li>
    <li><a href="#"><i class="fas fa-info-circle"></i> Event Status</a></li>
    <li><a href="#"><i class="fas fa-qrcode"></i> Event QR Code</a></li>
    <li><a href="#"><i class="fas fa-calendar-alt"></i> Upcoming Events</a></li>
</ul>
{% endif %}
{% endblock %}

{% block main_content %}
<script src="https://cdn.tailwindcss.com"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    .content { font-family: 'Inter', sans-serif; padding: 0 !important; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f0f4f8; }
    ::-webkit-scrollbar-thumb { background: #818cf8; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
</style>

<div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
        <h1 class="text-4xl font-extrabold text-indigo-700">Course Schedule Manager</h1>
        <p class="text-gray-600 mt-2">
            Manage your academic schedule. Data is saved to your browser's local storage.
        </p>
        <div class="mt-3 text-sm font-medium text-gray-500 bg-gray-100 p-2 rounded-lg shadow-sm">
            Status: Data saved locally in this browser instance.
        </div>
    </header>
    
    <section id="controls" class="mb-6 flex justify-end">
        {% if user.is_teacher %}
        <button id="add-course-btn" class="flex items-center space-x-2 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg shadow-indigo-200">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            <span>Add New Course</span>
        </button>
        {% endif %}
    </section>

    <!-- Schedule View with Scrolling -->
    <section id="schedule-view" class="bg-white rounded-3xl shadow-2xl p-4 md:p-6" style="max-height: calc(100vh - 360px); overflow-y: auto;">
        <h2 class="text-2xl font-bold mb-4 text-indigo-800 sticky top-0 bg-white z-10 pb-2">Weekly Timetable</h2>
        <div id="loading-spinner" class="text-center py-12 text-gray-500 hidden">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading schedule...
        </div>
        <div style="overflow-x: auto;">
            <table id="schedule-table" class="min-w-full divide-y divide-indigo-200 border border-indigo-200 rounded-xl overflow-hidden">
                <thead class="bg-indigo-50 sticky top-12 z-10">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider w-20">Time</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider">Monday</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider">Tuesday</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider">Wednesday</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider">Thursday</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider">Friday</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider">Saturday</th>
                        <th class="px-3 py-3 text-left text-xs font-bold text-indigo-600 uppercase tracking-wider">Sunday</th>
                    </tr>
                </thead>
                <tbody id="schedule-body" class="bg-white divide-y divide-indigo-100">
                </tbody>
            </table>
        </div>
        <p id="no-classes-message" class="text-center text-gray-400 py-6 hidden">
            No classes scheduled yet. {% if user.is_teacher %}Click "Add New Course" to get started!{% else %}Contact your teacher to add courses.{% endif %}
        </p>
    </section>
</div>

<!-- Centered Modal with Scrolling -->
<div id="course-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" style="overflow-y: auto;">
    <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full max-w-lg my-8" style="max-height: 90vh; overflow-y: auto;">
        <h3 id="modal-title" class="text-2xl font-bold mb-6 text-indigo-700 sticky top-0 bg-white z-10 pb-2">Add New Course</h3>

        <form id="course-form">
            <input type="hidden" id="course-id">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label for="course-name" id="course-name-label" class="block text-sm font-medium text-gray-700">Course Name / Subject</label>
                    <input type="text" id="course-name" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div id="course-code-group">
                    <label for="course-code" class="block text-sm font-medium text-gray-700">Course Code</label>
                    <input type="text" id="course-code" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div id="room-group">
                    <label for="room" class="block text-sm font-medium text-gray-700">Room / Location</label>
                    <input type="text" id="room" class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                
                <div class="md:col-span-2">
                    <label for="teacher-name" class="block text-sm font-medium text-gray-700">Teacher/Instructor Name</label>
                    <input type="text" id="teacher-name" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>

            <h4 class="text-lg font-semibold mt-4 mb-3 text-indigo-600">Class Schedule Time</h4>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="start-time" class="block text-sm font-medium text-gray-700">Class Start Time</label>
                    <input type="time" id="start-time" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="end-time" class="block text-sm font-medium text-gray-700">Class End Time</label>
                    <input type="time" id="end-time" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>

            <h4 class="text-lg font-semibold mt-4 mb-3 text-indigo-600">Attendance Window</h4>
            <p class="text-xs text-gray-500 mb-4">Attendance will automatically close at the assigned End Time.</p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="attendance-time-in" class="block text-sm font-medium text-gray-700">Attendance Time In</label>
                    <input type="time" id="attendance-time-in" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="attendance-time-end" class="block text-sm font-medium text-gray-700">Attendance Time End</label>
                    <input type="time" id="attendance-time-end" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Days of the Week</label>
                <div id="day-checkboxes" class="flex flex-wrap gap-2">
                    <label class="day-label"><input type="checkbox" name="days" value="M" class="hidden"> <span class="checkbox-span">Mon</span></label>
                    <label class="day-label"><input type="checkbox" name="days" value="T" class="hidden"> <span class="checkbox-span">Tue</span></label>
                    <label class="day-label"><input type="checkbox" name="days" value="W" class="hidden"> <span class="checkbox-span">Wed</span></label>
                    <label class="day-label"><input type="checkbox" name="days" value="Th" class="hidden"> <span class="checkbox-span">Thu</span></label>
                    <label class="day-label"><input type="checkbox" name="days" value="F" class="hidden"> <span class="checkbox-span">Fri</span></label>
                    <label class="day-label"><input type="checkbox" name="days" value="S" class="hidden"> <span class="checkbox-span">Sat</span></label>
                    <label class="day-label"><input type="checkbox" name="days" value="Su" class="hidden"> <span class="checkbox-span">Sun</span></label>
                </div>
                <style>
                    .checkbox-span {
                        display: block;
                        padding: 8px 12px;
                        border: 2px solid #e5e7eb;
                        border-radius: 12px;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-weight: 500;
                        color: #4b5563;
                        background-color: #f9fafb;
                    }
                    input[type="checkbox"]:checked + .checkbox-span {
                        background-color: #818cf8;
                        color: white;
                        border-color: #6366f1;
                        box-shadow: 0 4px 6px -1px rgba(129, 140, 248, 0.4);
                    }
                </style>
            </div>

            <h4 class="text-lg font-semibold mt-4 mb-3 text-indigo-600">Appearance</h4>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Color Theme</label>
                <div id="color-selector" class="flex flex-wrap gap-3"></div>
                <input type="hidden" id="course-color" value="#3b82f6">
            </div>

            <h4 class="text-lg font-semibold mt-4 mb-3 text-indigo-600">Attendance Period</h4>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Semester Start Date</label>
                    <input type="date" id="start-date" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700">Semester End Date</label>
                    <input type="date" id="end-date" required class="mt-1 block w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>

            <div class="flex justify-end space-x-3 sticky bottom-0 bg-white pt-4 pb-2">
                <button type="button" id="delete-course-btn" class="hidden px-4 py-2 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-150">
                    Delete Course
                </button>
                <button type="button" id="cancel-modal-btn" class="px-4 py-2 text-gray-700 bg-gray-200 font-semibold rounded-xl hover:bg-gray-300 transition duration-150">
                    Cancel
                </button>
                <button type="submit" id="save-course-btn" class="px-6 py-2 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition duration-150 shadow-md">
                    Save Course
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    var initialSchoolType = "{{ user.education_level|default:'HighSchool' }}";
    var isTeacher = "{{ user.is_teacher|yesno:'true,false' }}" === "true";
    
    const COURSES_KEY = 'schedule_manager_courses_v1';
    let allCourses = [];
    let currentSchoolType = initialSchoolType === 'high_senior' ? 'HighSchool' : 'University';

    const COLORS = [
        { value: '#3b82f6', background: 'bg-blue-100', border: 'border-blue-300', text: 'text-blue-800', hover: 'hover:bg-blue-200', name: 'Blue' },
        { value: '#10b981', background: 'bg-emerald-100', border: 'border-emerald-300', text: 'text-emerald-800', hover: 'hover:bg-emerald-200', name: 'Green' },
        { value: '#f97316', background: 'bg-orange-100', border: 'border-orange-300', text: 'text-orange-800', hover: 'hover:bg-orange-200', name: 'Orange' },
        { value: '#f43f5e', background: 'bg-rose-100', border: 'border-rose-300', text: 'text-rose-800', hover: 'hover:bg-rose-200', name: 'Red' },
        { value: '#a855f7', background: 'bg-purple-100', border: 'border-purple-300', text: 'text-purple-800', hover: 'hover:bg-purple-200', name: 'Purple' },
        { value: '#fbbf24', background: 'bg-amber-100', border: 'border-amber-300', text: 'text-amber-800', hover: 'hover:bg-amber-200', name: 'Yellow' },
    ];
    
    function getColorClasses(hexValue) {
        return COLORS.find(c => c.value === hexValue) || COLORS[0]; 
    }

    const scheduleBody = document.getElementById('schedule-body');
    const modal = document.getElementById('course-modal');
    const form = document.getElementById('course-form');
    const modalTitle = document.getElementById('modal-title');
    const courseIdInput = document.getElementById('course-id');
    const deleteBtn = document.getElementById('delete-course-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const noClassesMessage = document.getElementById('no-classes-message');
    const colorInput = document.getElementById('course-color');
    const colorSelectorDiv = document.getElementById('color-selector');
    const courseCodeGroup = document.getElementById('course-code-group');
    const roomGroup = document.getElementById('room-group');
    const courseNameLabel = document.getElementById('course-name-label');
    const saveBtn = document.getElementById('save-course-btn');
    const cancelBtn = document.getElementById('cancel-modal-btn');

    const CourseCRUD = {
        initStorage() {
            try {
                const coursesJson = localStorage.getItem(COURSES_KEY);
                allCourses = coursesJson ? JSON.parse(coursesJson) : [];
            } catch (error) {
                console.error("Error initializing local storage:", error);
                allCourses = [];
            }
        },

        saveAllCoursesToStorage() {
            try {
                localStorage.setItem(COURSES_KEY, JSON.stringify(allCourses));
            } catch (e) {
                console.error("Error saving courses to local storage:", e);
            }
        },

        loadAndRenderCourses() {
            loadingSpinner.classList.remove('hidden');
            const filteredCourses = allCourses.filter(course => 
                course.schoolType === currentSchoolType
            );
            this.renderSchedule(filteredCourses);
            noClassesMessage.classList.toggle('hidden', filteredCourses.length > 0);
            loadingSpinner.classList.add('hidden');
        },

        saveCourse(courseData, courseId) {
            if (courseId) {
                const index = allCourses.findIndex(c => c.id === courseId);
                if (index !== -1) {
                    allCourses[index] = { id: courseId, ...courseData };
                }
            } else {
                const newId = Date.now().toString(36) + Math.random().toString(36).substring(2);
                allCourses.push({ id: newId, ...courseData });
            }
            this.saveAllCoursesToStorage();
            this.loadAndRenderCourses();
            Modal.hide();
        },

        deleteCourse(courseId) {
            if (!window.confirm("Are you sure you want to delete this course? This action cannot be undone.")) {
                return;
            }
            allCourses = allCourses.filter(c => c.id !== courseId);
            this.saveAllCoursesToStorage();
            this.loadAndRenderCourses();
            Modal.hide();
        },

        renderSchedule(courses) {
            const timeSlots = generateTimeSlots();
            const days = ["M", "T", "W", "Th", "F", "S", "Su"];
            
            const scheduleMap = timeSlots.map(time => {
                const row = { time };
                days.forEach(day => row[day] = []);
                return row;
            });

            courses.forEach(course => {
                const startMin = timeToMinutes(course.startTime);
                const endMin = timeToMinutes(course.endTime);
                const alignedStartMin = Math.floor(startMin / 30) * 30;
                const startIndex = timeSlots.findIndex(t => timeToMinutes(t) === alignedStartMin);
                
                if (startIndex === -1) return;

                const durationMin = endMin - startMin;
                const durationSlots = Math.ceil(durationMin / 30);
                
                course.days.forEach(dayKey => {
                    if (days.includes(dayKey)) {
                        const courseData = { 
                            ...course, 
                            rowspan: durationSlots,
                            isContinuation: false
                        };
                        
                        if (startIndex < scheduleMap.length) {
                            scheduleMap[startIndex][dayKey].push(courseData);
                        }

                        for (let i = 1; i < durationSlots; i++) {
                            const nextIndex = startIndex + i;
                            if (nextIndex < scheduleMap.length) {
                                scheduleMap[nextIndex][dayKey].push({ isContinuation: true });
                            }
                        }
                    }
                });
            });

            let html = '';
            scheduleMap.forEach(row => {
                html += `<tr class="hover:bg-indigo-50 transition duration-100">`;
                html += `<td class="px-3 py-2 text-sm font-semibold text-gray-800 border-r border-indigo-100">${formatTimeDisplay(row.time)}</td>`;
                
                days.forEach(dayKey => {
                    const cellContent = row[dayKey];
                    
                    if (cellContent.length === 0) {
                        html += `<td class="px-3 py-2 text-xs text-gray-400 border-r border-indigo-100"></td>`;
                    } else {
                        const firstItem = cellContent[0];
                        
                        if (firstItem.isContinuation) {
                            return;
                        } else {
                            const course = firstItem;
                            const colorClasses = getColorClasses(course.color);
                            const isHighSchoolCourse = course.schoolType === 'HighSchool';
                            const mainIdentifier = isHighSchoolCourse ? course.courseName : `${course.courseCode || 'N/A'} - ${course.courseName}`;
                            const locationDisplay = course.room ? ` in ${course.room}` : '';
                            
                            html += `
                                <td rowspan="${course.rowspan}" data-id="${course.id}" 
                                    class="p-2 cursor-pointer ${colorClasses.background} ${colorClasses.hover} transition duration-150 
                                    rounded-xl border ${colorClasses.border} shadow-md relative group"
                                    onclick="${isTeacher ? `Modal.edit('${course.id}')` : `Modal.view('${course.id}')`}"
                                >
                                    <div class="font-bold text-sm ${colorClasses.text}">${mainIdentifier}</div>
                                    <div class="text-xs text-gray-700 font-medium">
                                        <span class="font-semibold">Instructor:</span> ${course.teacherName}
                                    </div>
                                    <div class="text-xs text-gray-700 mt-1">
                                        ${formatTimeDisplay(course.startTime)} - ${formatTimeDisplay(course.endTime)}${locationDisplay}
                                    </div>
                                    <div class="text-xs text-gray-600 mt-2 border-t border-dashed border-gray-400 pt-1">
                                        <span class="font-semibold">Attendance:</span> ${formatTimeDisplay(course.attendanceTimeIn)} - ${formatTimeDisplay(course.attendanceTimeEnd)}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span class="font-semibold">Period:</span> ${formatDateDisplay(course.startDate)} to ${formatDateDisplay(course.endDate)}
                                    </div>
                                </td>
                            `;
                        }
                    }
                });
                html += `</tr>`;
            });

            scheduleBody.innerHTML = html;
        }
    };

    function timeToMinutes(time) {
        const [h, m] = time.split(':').map(Number);
        return h * 60 + m;
    }

    function formatTimeDisplay(time) {
        if (!time) return 'N/A';
        const [h, m] = time.split(':').map(Number);
        const period = h >= 12 ? 'PM' : 'AM';
        const hour = h % 12 || 12;
        return `${hour}:${m.toString().padStart(2, '0')} ${period}`;
    }

    function formatDateDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return new Date(date.getTime() + date.getTimezoneOffset() * 60000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function generateTimeSlots() {
        const slots = [];
        const combinedStartMin = 5 * 60 + 30; 
        const combinedEndMin = 20 * 60 + 30; 

        for (let m = combinedStartMin; m <= combinedEndMin; m += 30) {
            const h = Math.floor(m / 60);
            const min = m % 60;
            slots.push(`${h.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
        }
        return slots;
    }

    function renderColorSelector(defaultColor) {
        colorSelectorDiv.innerHTML = COLORS.map(color => `
            <label class="cursor-pointer relative group p-1 rounded-full border-2 border-transparent hover:border-gray-400 transition">
                <input type="radio" name="color-select" value="${color.value}" class="hidden">
                <span title="${color.name}" class="inline-block w-8 h-8 rounded-full border-4 border-white shadow-md transition-all duration-200"
                      style="background-color: ${color.value};">
                </span>
                <div class="absolute inset-0 rounded-full ring-2 ring-transparent transition duration-200 pointer-events-none selected-ring"></div>
            </label>
        `).join('');
        
        const updateSelection = (value) => {
            colorInput.value = value;
            colorSelectorDiv.querySelectorAll('input[name="color-select"]').forEach(input => {
                const ring = input.closest('label').querySelector('.selected-ring');
                if (input.value === value) {
                    input.checked = true;
                    ring.classList.add('ring-indigo-500');
                    ring.classList.remove('ring-transparent');
                } else {
                    input.checked = false;
                    ring.classList.remove('ring-indigo-500');
                    ring.classList.add('ring-transparent');
                }
            });
        };

        updateSelection(defaultColor || COLORS[0].value);
        colorSelectorDiv.querySelectorAll('input[name="color-select"]').forEach(input => {
            input.addEventListener('change', (e) => updateSelection(e.target.value));
        });
    }

    const Modal = {
        show: (mode, courseData = {}) => {
            const isEdit = mode === 'edit';
            const isView = mode === 'view';
            modalTitle.textContent = isView ? 'View Course Details' : (isEdit ? 'Edit Course Details' : 'Add New Course');
            deleteBtn.classList.toggle('hidden', !isEdit);
            saveBtn.classList.toggle('hidden', isView);
            form.reset();
            courseIdInput.value = '';
            
            const defaultColor = courseData.color || COLORS[0].value;
            renderColorSelector(defaultColor); 

            const isHighSchool = currentSchoolType === 'HighSchool';
            courseCodeGroup.classList.toggle('hidden', isHighSchool);
            roomGroup.classList.toggle('hidden', isHighSchool);
            courseNameLabel.textContent = isHighSchool ? 'Subject Name' : 'Course Name / Subject';

            const inputs = form.querySelectorAll('input:not([type="hidden"]), select');
            inputs.forEach(input => {
                input.disabled = isView;
            });
            const checkboxes = document.querySelectorAll('input[name="days"]');
            checkboxes.forEach(cb => {
                cb.disabled = isView;
            });
            if (isView) {
                colorSelectorDiv.style.display = 'none';
            } else {
                colorSelectorDiv.style.display = 'flex';
            }

            if (isEdit || isView) {
                courseIdInput.value = courseData.id || '';
                document.getElementById('course-name').value = courseData.courseName || '';
                document.getElementById('course-code').value = courseData.courseCode || '';
                document.getElementById('room').value = courseData.room || '';
                document.getElementById('teacher-name').value = courseData.teacherName || '';
                document.getElementById('attendance-time-in').value = courseData.attendanceTimeIn || '';
                document.getElementById('attendance-time-end').value = courseData.attendanceTimeEnd || '';
                document.getElementById('start-time').value = courseData.startTime || '';
                document.getElementById('end-time').value = courseData.endTime || '';
                document.getElementById('start-date').value = courseData.startDate || '';
                document.getElementById('end-date').value = courseData.endDate || '';
                colorInput.value = defaultColor; 
                
                const dayCheckboxes = document.getElementsByName('days');
                const selectedDays = courseData.days || [];
                dayCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectedDays.includes(checkbox.value);
                });

                if (isEdit) {
                    deleteBtn.onclick = () => CourseCRUD.deleteCourse(courseData.id);
                }
            }
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        },
        
        hide: () => {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        },

        edit(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (course) {
                Modal.show('edit', course);
            }
        },
        
        view(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (course) {
                Modal.show('view', course);
            }
        }
    };

    window.Modal = Modal;

    const addCourseBtn = document.getElementById('add-course-btn');
    if (addCourseBtn) {
        addCourseBtn.addEventListener('click', () => Modal.show('add'));
    }
    cancelBtn.addEventListener('click', Modal.hide);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) Modal.hide(); 
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        const courseId = courseIdInput.value;
        const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);

        if (selectedDays.length === 0) {
            alert("Please select at least one day for the class.");
            return;
        }

        const isHighSchool = currentSchoolType === 'HighSchool';

        const courseData = {
            courseName: document.getElementById('course-name').value.trim(),
            teacherName: document.getElementById('teacher-name').value.trim(),
            attendanceTimeIn: document.getElementById('attendance-time-in').value,
            attendanceTimeEnd: document.getElementById('attendance-time-end').value,
            startTime: document.getElementById('start-time').value,
            endTime: document.getElementById('end-time').value,
            startDate: document.getElementById('start-date').value,
            endDate: document.getElementById('end-date').value,
            days: selectedDays,
            color: colorInput.value, 
            schoolType: currentSchoolType,
            courseCode: isHighSchool ? '' : document.getElementById('course-code').value.trim(),
            room: isHighSchool ? '' : document.getElementById('room').value.trim(),
        };
        
        CourseCRUD.saveCourse(courseData, courseId || null);
    });

    window.onload = () => {
        CourseCRUD.initStorage();
        CourseCRUD.loadAndRenderCourses();
    };
</script>
{% endblock %}